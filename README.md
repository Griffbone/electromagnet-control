# Electromagnet-Control
Embedded C code for the Low-Gravity Science and Tecnology (LGST) lab at Georgia Tech electromagnet array drivers. Thise code is designed to be run on the STM32C0XXXX microcontroller (MCU). The repository utilizes Lazo Attar's STM32 configuration manager toolchain.

## First-Time Setup
To run this toolchain on Linux, you will need the following:
- MAKE for compiling the project
- OpenOCD or STM32CubeProgrammer for programming/debugging
- STM32 CubeMX for generating HAL libraries. This project used version 6.9.2 to generate the .ioc and HAL files. 

## Building the Project
This section describes how to configure, build, and deploy the project. Lazo has created a very useful set of tools for configuring this repository that make this entire process significantly easier. The general steps are: 

1. Configure the repository and Makefile
2. Build the project
3. Flash the program

These steps are elaborated in the sections below.

### Makefile Configuration
The configuration tool relocates files generated by STM32CubeMX and generates a makefile for the project automatically. This allows us to maintain a clean main.c file for a more streamlined programming experience. To run the tool, we simply call: 

```./tools/configure.sh -c data/configs/main -p . -m stm32c0```. 

The flags for this tool are shown below:

- ```-c``` path to the CubeMX config we want to use. In the example, we are using the config located in ```data/configs/main```. More .ioc files can be created and called here for ports to different microcontrollers or pinout configurations.  
- ```-p``` is the type of processor we want to compile to. In this case, we are using the STM32C0.
- ```-e``` is a flag we use to add extra libraries to the makefile. It is unused here. 

There is also a bug in this makefile setup that appears to be specific to STM32C0 cores. To fix this bug simply change the line:

```MCU = $(CPU) -mthumb $(FPU) $(FLOAT-ABI)```

To: 

```MCU = -mcpu=cortex-m0plus```

After running the configuration tool. 

### Building the project
Once the makefile is configured, we can build the project. We can do this simply through MAKE, with a call to: 

```make -j$(nproc)```

The ```-j$(nproc)``` flag uses all your computer's available cores so that the code is built faster by using parallel processing.

### Flashing code
This repository contains a ```stm32c0x.cfg``` file in it. Transfer this into your OpenOCD target folder (should be in ```/usr/share/openocd/scripts/target``` path or similar). Once this is done, you can use the following command to flash the compiled program: 

```openocd -f interface/stlink.cfg -f target/stm32c0x.cfg -c "init" -c "reset halt" -c "load_image build/main/main.bin 0x08000000" -c "reset run" -c "exit"```

Here, we first use -f to tell the program which programming method to use, then -f to tell it which processor we are targetting, followed by -c to tell OpenOCD which binary we are writing where to write it in memory. 