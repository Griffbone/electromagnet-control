# Electromagnet-Control
Embedded C code for the Low-Gravity Science and Tecnology (LGST) lab at Georgia Tech electromagnet array drivers. Thise code is designed to be run on the STM32C0XXXX microcontroller (MCU). The repository utilizes Lazo Attar's STM32 configuration manager toolchain.

## First-Time Setup
To run this toolchain on Linux, you will need the following:
- MAKE for compiling the project
- OpenOCD or STM32CubeProgrammer for programming/debugging
- STM32 CubeMX for generating HAL libraries. This project used version 6.9.2 to generate the .ioc and HAL files. 

## Building the Project
This section describes how to configure, build, and deploy the project. Lazo has created a very useful set of tools for configuring this repository that make this entire process significantly easier. The general steps are: 

1. Configure the repository and Makefile
2. Build the project
3. Flash the program

These steps are elaborated in the sections below.

### Makefile Configuration
The configuration tool relocates files generated by STM32CubeMX and generates a makefile for the project automatically. This allows us to maintain a clean main.c file for a more streamlined programming experience. To run the tool, we simply call: 

```./tools/configure.sh -c data/configs/main -p . -m stm32c0```. 

The flags for this tool are shown below:

- ```-c``` path to the CubeMX config we want to use. In the example, we are using the config located in ```data/configs/main```. More .ioc files can be created and called here for ports to different microcontrollers or pinout configurations.  
- ```-p``` is the type of processor we want to compile to. In this case, we are using the STM32C0.
- ```-e``` is a flag we use to add extra libraries to the makefile. It is unused here. 

There is also a bug in this makefile setup that appears to be specific to STM32C0 cores. To fix this bug simply change the line:

```MCU = $(CPU) -mthumb $(FPU) $(FLOAT-ABI)```

To: 

```MCU = -mcpu=cortex-m0plus```

After running the configuration tool. 

### Building the project
Once the makefile is configured, we can build the project. We can do this simply through MAKE, with a call to: 

```make -j$(nproc)```

The ```-j$(nproc)``` flag uses all your computer's available cores so that the code is built faster by using parallel processing.

### Flashing code
The STM32C0 is unsupported by OpenOCD, which would be my preferred method of flashing this board. I attempted to use a config file generated by STM32CubeProgrammer with OpenOCD to flash the system but found that to be a waste of my time (I am sure it is possible, just didn't want to spend a day working on flashing a board). Instead, to flash the board, use STM32CubeProgrammer: simply:

1. Open STM32CubeProgrammer 
2. In the Download tab, select the path to the .elf file to flash (```build/main/main.elf```), enable "verify programming" and "run after programming"
3. Hit the green "connect" button to connect to the ST-Link programmer on the development board
4. Hit the blue "start programming" button in the download tab to flash the program 

Alternatively, STM32CubeProgrammer can be run in the command line via: 

```<path to cli application>/STM32_Programmer_CLI -c port=SWD -w build/main/main.bin 0x08000000 -v -rst```

For me, this looks like: 
```/home/griffin/STMicroelectronics/STM32Cube/STM32CubeProgrammer/bin/STM32_Programmer_CLI -c port=SWD -w build/main/main.bin 0x08000000 -v -rst```